package wallet

import (
	"context"
	"etherum-monitor/config"
	"etherum-monitor/utils"
	"fmt"
	"math/big"
	"strings"

	ethereum "github.com/HydroProtocol/ethereum-watcher"
	"github.com/HydroProtocol/ethereum-watcher/structs"
)

type EtherenumThransactionPlugin struct {
	targetAddress string
	threshold     *big.Int
}

func (p *EtherenumThransactionPlugin) AcceptTx(tx structs.RemovableTx) {
	// å…ˆæ‰“å°æ‰€æœ‰äº¤æ˜“ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ•°æ®è¿›æ¥
	fmt.Printf("ğŸ“¥ æ”¶åˆ°äº¤æ˜“ - åŒºå—: %d, å“ˆå¸Œ: %s\n", tx.GetBlockNumber(), tx.GetHash())

	// ä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„æ¯”è¾ƒ
	from := strings.ToLower(tx.GetFrom())
	to := strings.ToLower(tx.GetTo())
	target := strings.ToLower(p.targetAddress)
	fmt.Printf("ç›®æ ‡åœ°å€ï¼š%s,å‘é€åœ°å€:%s,æ¥æ”¶åœ°å€:%s\n", target, from, to)
	if from != target && to != target {
		return
	}

	value := tx.GetValue()
	fmt.Printf("âœ… åŒ¹é…åˆ°ç›®æ ‡åœ°å€çš„äº¤æ˜“ï¼š%s\n", tx.GetHash())
	fmt.Printf("é‡‘é¢ï¼š%s ETH\n", weiToEth(&value))
	fmt.Printf("å‘é€æ–¹ï¼š%s\n", tx.GetFrom())
	fmt.Printf("æ¥æ”¶æ–¹ï¼š%s\n", tx.GetTo())
	fmt.Printf("åŒºå—å·ï¼š%d\n", tx.GetBlockNumber())
	fmt.Printf("å½“å‰gasï¼š%s\n", tx.GetGasPrice())

	if value.Cmp(p.threshold) > 0 {
		p.processTransaction(tx)
	}
}

func (p *EtherenumThransactionPlugin) processTransaction(tx structs.RemovableTx) {
	if tx.IsRemoved {
		fmt.Printf("äº¤æ˜“è¢«åˆ é™¤ï¼š%s\n", tx.GetHash())
		return
	}
	direction := "è½¬å…¥"
	if tx.GetFrom() == p.targetAddress {
		direction = "è½¬å‡º"
	}
	value := tx.GetValue()
	fmt.Printf("\nğŸš¨ å¤§é¢äº¤æ˜“å‘Šè­¦ï¼\n")
	fmt.Println("----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
	fmt.Printf("äº¤æ˜“æ–¹å‘ï¼š%s\n", direction)
	fmt.Printf("äº¤æ˜“å“ˆå¸Œï¼š%s\n", tx.GetHash())
	fmt.Printf("é‡‘é¢ï¼š%s ETH\n", weiToEth(&value))
	fmt.Printf("å‘é€æ–¹ï¼š%s\n", tx.GetFrom())
	fmt.Printf("æ¥æ”¶æ–¹ï¼š%s\n", tx.GetTo())
	fmt.Printf("åŒºå—å·ï¼š%d\n", tx.GetBlockNumber())
	fmt.Println("----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
}

// åˆ›å»º 10 ETH çš„é˜ˆå€¼
func createThreshold() *big.Int {
	threshold := big.NewInt(0)
	threshold.SetString("10000000000000000000", config.ETH_THRESHOLD)
	return threshold
}

func weiToEth(wei *big.Int) string {
	ethWei := new(big.Float).SetInt(wei)
	divisor := new(big.Float).SetFloat64(1e18)
	result := new(big.Float).Quo(ethWei, divisor)
	return result.String()
}

func AddressAddMonitor() {
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("ğŸš€ ä»¥å¤ªåŠé’±åŒ…ç›‘æ§ç¨‹åºå¯åŠ¨")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

	// å¿…é¡»åœ¨åˆ›å»º watcher ä¹‹å‰è®¾ç½®ä»£ç†
	fmt.Println("âš™ï¸  æ­£åœ¨é…ç½®ä»£ç†...")
	utils.SetGlobalProxy()
	fmt.Println("âœ“ ä»£ç†å·²è®¾ç½®: http://127.0.0.1:7890")

	ethereumPlugin := &EtherenumThransactionPlugin{
		targetAddress: config.OKX_WALLET_ADDRESS,
		threshold:     createThreshold(),
	}

	fmt.Println("âš™ï¸  æ­£åœ¨åˆ›å»º Watcher...")
	watcher := ethereum.NewHttpBasedEthWatcher(context.Background(), config.ETHEREUM_RPC_URL)

	// è®¾ç½®è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
	watcher.SetSleepSecondsForNewBlock(config.SLEEP_SECONDS_FOR_NEW_BLOCK)
	fmt.Printf("âœ“ è½®è¯¢é—´éš”: %d ç§’\n", config.SLEEP_SECONDS_FOR_NEW_BLOCK)

	watcher.RegisterTxPlugin(ethereumPlugin)
	fmt.Println("âœ“ æ’ä»¶å·²æ³¨å†Œ")

	fmt.Printf("ğŸ‘€ ç›‘å¬é’±åŒ…åœ°å€ï¼š%s\n", config.OKX_WALLET_ADDRESS)
	fmt.Println("ğŸ’° å‘Šè­¦é˜ˆå€¼: 10 ETH")
	fmt.Println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
	fmt.Println("â³ ç­‰å¾…æ–°åŒºå—...")
	fmt.Println()

	err := watcher.RunTillExit()
	if err != nil {
		fmt.Printf("âŒ è¿è¡Œé”™è¯¯ï¼š%v\n", err)
		return
	}
}
